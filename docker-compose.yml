services:
  jobs:
    build: .
    env_file: .env
    environment:
      - TZ=${TZ:-Europe/Moscow}
      - HOME=/home/jobs
      - BROWSER_CDP_URL=http://browser:9223
    volumes:
      - ./data:/data              # Персистентные данные (сессия, БД)
      - ./data/.claude:/home/jobs/.claude  # Claude Code credentials
      - jobs-workspace:/workspace  # Рабочая директория Claude
      - ./skills:/workspace/.claude/skills  # Skills для SDK
      - browser-recordings:/recordings:ro  # Аудио-записи из браузера (read-only)
      - browser-control:/browser-control    # Управление браузером (proxy toggle)
    restart: unless-stopped
    stdin_open: true              # Для интерактивного логина
    tty: true
    depends_on:
      browser:
        condition: service_healthy

  browser:
    build: ./browser
    environment:
      - TZ=${TZ:-Europe/Moscow}
      - RESOLUTION=1920x1080x24
      - HTTP_PROXY=${HTTP_PROXY:-}
    volumes:
      - browser-profile:/home/browser/.config/chromium  # Персистентный профиль
      - browser-downloads:/home/browser/Downloads       # Скачанные файлы
      - browser-recordings:/recordings                  # Аудио-записи (10-мин чанки)
      - browser-control:/browser-control                # Управление из jobs (proxy toggle)
    ports:
      - "6080:6080"               # noVNC web interface (для просмотра)
      - "9223:9223"               # CDP proxy (для отладки)
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9223/json"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  jobs-workspace:                 # Named volume для workspace
  browser-profile:                # Профиль Chromium (куки, сессии, история)
  browser-downloads:              # Скачанные файлы
  browser-recordings:             # Аудио-записи браузера (shared, 24ч retention)
  browser-control:               # Управление браузером (proxy toggle)
